#!/usr/bin/env python3
"""Create a Steam shortcut for a devkit game.

This script creates a Steam shortcut for a devkit game using steam-shortcut-manager.
Modified for Bazzite/Universal devkit - uses steam-shortcut-manager instead of Steam IPC.
"""

import os
import logging
import argparse
import json
import platform

import devkit_utils

logging.basicConfig(format='%(message)s', level=logging.DEBUG)
logger = logging.getLogger()

DEVKIT_TOOL_FOLDER = os.path.expanduser('~/devkit-game')

# Prefix used to identify devkit shortcuts in Steam
DEVKIT_SHORTCUT_PREFIX = 'Devkit: '


def find_game_executable(game_dir, gameid):
    """Find the game executable in the game directory.

    Args:
        game_dir: Path to the game directory
        gameid: The game identifier

    Returns:
        Path to the executable
    """
    # Prefer launch.sh if it exists
    launch_script = os.path.join(game_dir, 'launch.sh')
    if os.path.exists(launch_script):
        return launch_script

    # Try gameid as executable name
    gameid_exe = os.path.join(game_dir, gameid)
    if os.path.exists(gameid_exe) and os.access(gameid_exe, os.X_OK):
        return gameid_exe

    # Try gameid.sh
    gameid_sh = os.path.join(game_dir, gameid + '.sh')
    if os.path.exists(gameid_sh):
        return gameid_sh

    # Fallback to launch.sh path even if it doesn't exist yet
    return launch_script


if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description='Create a Steam shortcut for a devkit game'
    )
    parser.add_argument('--verbose', required=False, action='store_true')
    parser.add_argument('--parms', required=True, action='store',
                        help='JSON string containing game parameters')
    conf = parser.parse_args()

    if conf.verbose:
        logger.setLevel(logging.DEBUG)
    else:
        logger.setLevel(logging.INFO)

    parms = json.loads(conf.parms)
    gameid = parms['gameid']
    directory = parms['directory']
    assert os.path.isdir(directory)

    logger.info(f'Updating command line and runtime settings for {gameid} on {platform.node()}')

    # Save command line arguments and settings
    devkit_utils.save_argv(gameid, parms.get('argv'))
    devkit_utils.save_settings(gameid, parms)

    ret = {}

    # Check if steam-shortcut-manager is available
    if not devkit_utils.shortcut_manager_available():
        error_msg = (
            'steam-shortcut-manager binary not found. '
            'Please ensure the binary is in the bin/ directory.'
        )
        logger.error(error_msg)
        ret['error'] = error_msg
        print(json.dumps(ret))
        exit(1)

    try:
        # Validate Steam is installed
        devkit_utils.validate_steam_client()
    except devkit_utils.SteamNotInstalledException as e:
        skipping = f'Steam is not installed: {e}. Registration did not complete.'
        logger.warning(skipping)
        ret['error'] = skipping
    except devkit_utils.SteamClientNotRunningException as e:
        # This is now just informational in Bazzite mode
        logger.info(f'Steam client status: {e}')
        # Continue anyway since we use steam-shortcut-manager
    except Exception as e:
        logger.warning(f'Steam validation warning: {e}')

    if 'error' not in ret:
        # Construct the shortcut
        game_dir = os.path.join(directory, gameid)
        shortcut_name = f'{DEVKIT_SHORTCUT_PREFIX}{gameid}'
        exe = find_game_executable(game_dir, gameid)

        logger.info(f'Registering Devkit Game {gameid} with Steam')

        try:
            result = devkit_utils.add_steam_shortcut(
                name=shortcut_name,
                exe=exe,
                start_dir=game_dir,
                tags=['devkit']
            )
            ret['success'] = f'Shortcut created for {gameid}'
            logger.info(f'Successfully registered {gameid}')
        except Exception as e:
            ret['error'] = f'Failed to create shortcut: {e}'
            logger.error(ret['error'])

    # Response gets written out to stdout
    print(json.dumps(ret))
